{% extends 'frontend.html.twig' %}
{% block title %}
    {{ cancion.titulo|split('.')[0] }}
{% endblock %}

{% block styles %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/cancion.css') }}">
    <link rel="stylesheet" href="{{ asset('css/navUsuario.css') }}">
    <style>
        #search-form {
            display: none;
        }
        .song-image {
            width: 300px; /* Ajusta a tu tamaño deseado */
            height: 300px; /* Ajusta a tu tamaño deseado */
            object-fit: cover;
            border-radius: 10px; /* Opcional: añade bordes redondeados si lo deseas */
        }
    </style>
{% endblock %}

{% block body %}
    {% include 'nav.html.twig' %}
    <!-- Detalles de la canción -->
    <section class="container container-cancion mt-5">
        <div class="row">
            <div class="col-md-6 offset-md-3 text-center cancion-imagen">
                <img src="{{ '/images/grupos/' ~ cancion.album.fotoPortada }}" alt="Canción" class="song-image">
                <h2 class="tituloCancion mb-3">{{ cancion.titulo|split('.')[0] }}</h2>
                <p class="mb-4">{{ cancion.artista.nombre }}</p>
                
                <!-- Enlace para ver el álbum -->
                <p class="mb-4">
                    <a id="albumEnlace" href="{{ path('app_verAlbum', { 'id': cancion.album.id }) }}">
                        <i class="fa-regular fa-eye"></i> {{ cancion.album.nombre }}
                    </a>
                </p>

                <div class="container utiles d-flex justify-content-end justify-content-md-end align-items-end">
                    <div class="volume-bar d-flex align-items-center">
                        <i class="fas fa-volume-up me-2" id="volumeIcon"></i>
                        <input id="volumeSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="1">
                        <a id="heart-icon-empty" class="nav-link ms-2" href="#">
                            <i class="far fa-heart corazon"></i>
                        </a>
                        <a id="heart-icon-full" class="nav-link ms-2" href="#" style="display: none;">
                            <i class="fas fa-heart text-custom corazonLleno"></i>
                        </a>
                    </div>
                </div>

                <div class="player-controls d-flex justify-content-center">
                    <button class="btn btn-light me-3" id="btnBackward">
                        <i class="fas fa-backward"></i>
                    </button>

                    <button id="playButton" class="btn btn-light me-3">
                        <i class="fas fa-play"></i>
                    </button>

                    <button id="pauseButton" class="btn btn-light me-3" style="display: none;">
                        <i class="fas fa-pause"></i>
                    </button>

                    <button class="btn btn-light" id="btnForward">
                        <i class="fas fa-forward"></i>
                    </button>
                </div>
                <div class="playback-bar mt-3">
                    <input id="seekSlider" type="range" class="form-range" min="0" max="100" value="0">
                    <div class="d-flex justify-content-between">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">-:--</span>
                    </div>
                </div>
                <!-- Botón para volver a la página principal -->
                <a href="{{ path('app_home') }}" id="volverPrincipal" class="btn btn-primary mt-4">
                    Volver a Principal
                </a>
                <!-- Botón para ir a mis canciones -->
                <a href="{{ path('app_misCanciones') }}" id="irAMisCanciones" class="btn btn-secondary mt-4">
                    Ir a Mis Canciones
                </a>
            </div>
        </div>
    </section>

    <audio id="audio" data-tiempo="{{ tiempo }}" data-volumen="{{ volumen }}" data-corazon="{{ corazon }}" data-cancion-id="{{ cancion.id }}" src="{{ asset('music/' ~ cancion.titulo) }}" ontimeupdate="actualizarTiempo()"></audio>
{% endblock %}

{% block custom_javascripts %}
    <script src="{{ asset('js/detalleCancion.js') }}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const volverPrincipalBtn = document.getElementById("volverPrincipal");
            const irAMisCancionesBtn = document.getElementById("irAMisCanciones");
            const albumEnlace = document.getElementById("albumEnlace");
            const audio = document.getElementById("audio");
            const heartIconEmpty = document.getElementById("heart-icon-empty");
            const heartIconFull = document.getElementById("heart-icon-full");
            const artistName = document.querySelector(".tituloCancion + p");
            const songImage = document.querySelector(".song-image");

            if (!volverPrincipalBtn || !irAMisCancionesBtn || !albumEnlace || !audio || !heartIconEmpty || !heartIconFull || !artistName || !songImage) {
                console.error("Algunos elementos del DOM no fueron encontrados");
                return;
            }

            function saveAudioDataAndRedirect(redirectUrl) {
                const isHearted = heartIconFull.style.display === "block";
                const currentTime = audio.currentTime;
                const volume = audio.volume;
                const corazon = isHearted ? 1 : 0;

                // Guardar datos en localStorage
                const audioData = {
                    id: audio.dataset.cancionId,
                    src: audio.src,
                    currentTime: currentTime,
                    volume: volume,
                    corazon: corazon,
                    artista: artistName.innerText,
                    imagen: songImage.src
                };
                localStorage.setItem("audioData", JSON.stringify(audioData));

                // Redirigir a la página correspondiente
                window.location.href = redirectUrl;
            }

            volverPrincipalBtn.addEventListener("click", function (event) {
                event.preventDefault();
                saveAudioDataAndRedirect("{{ path('app_home') }}");
            });

            irAMisCancionesBtn.addEventListener("click", function (event) {
                event.preventDefault();
                saveAudioDataAndRedirect("{{ path('app_misCanciones') }}");
            });

            albumEnlace.addEventListener("click", function (event) {
                event.preventDefault();
                saveAudioDataAndRedirect("{{ path('app_verAlbum', { 'id': cancion.album.id }) }}");
            });
        });
    </script>
{% endblock %}
